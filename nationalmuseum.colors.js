var Canvas = require('canvas');
var colorThief = require('thief');
var _ = require('underscore');
var fs = require('fs');

var chroma = require('chroma-js');

var colorObject = function(color) {
    var hex = chroma(color).hex();
    var hsv = chroma(color).hsv();
    var temperature = chroma(color).temperature();

    return {
        rgb: color,
        hex: hex,
        hsv: [
            hsv[0] == null ? 0 : Math.round(hsv[0]), 
            hsv[1] == null ? 0 : Math.round(hsv[1]*100), 
            hsv[2] == null ? 0 : Math.round(hsv[2]*100)
        ],
        temperature: temperature
    };
};

var mapColorToPalette = function(colorToMap) {
	var color, diffR, diffG, diffB, diffDistance, mappedColor;
	var distance = 25000;

	for (var i = 0; i < colors216.length; i++) {
		color = colors216[i];
		diffR = (color[0] - colorToMap[0]);
		diffG = (color[1] - colorToMap[1]);
		diffB = (color[2] - colorToMap[2]);
		diffDistance = diffR * diffR + diffG * diffG + diffB * diffB;
		if (diffDistance < distance) {
			distance = diffDistance;
			mappedColor = colors216[i];
		};
	}
	return (mappedColor);
};

var colors216 = [
    [
        0,
        0,
        0
    ],
    [
        0,
        0,
        51
    ],
    [
        0,
        0,
        102
    ],
    [
        0,
        0,
        153
    ],
    [
        0,
        0,
        204
    ],
    [
        0,
        0,
        255
    ],
    [
        0,
        51,
        0
    ],
    [
        0,
        51,
        51
    ],
    [
        0,
        51,
        102
    ],
    [
        0,
        51,
        153
    ],
    [
        0,
        51,
        204
    ],
    [
        0,
        51,
        255
    ],
    [
        0,
        102,
        0
    ],
    [
        0,
        102,
        51
    ],
    [
        0,
        102,
        102
    ],
    [
        0,
        102,
        153
    ],
    [
        0,
        102,
        204
    ],
    [
        0,
        102,
        255
    ],
    [
        0,
        153,
        0
    ],
    [
        0,
        153,
        51
    ],
    [
        0,
        153,
        102
    ],
    [
        0,
        153,
        153
    ],
    [
        0,
        153,
        204
    ],
    [
        0,
        153,
        255
    ],
    [
        0,
        204,
        0
    ],
    [
        0,
        204,
        51
    ],
    [
        0,
        204,
        102
    ],
    [
        0,
        204,
        153
    ],
    [
        0,
        204,
        204
    ],
    [
        0,
        204,
        255
    ],
    [
        0,
        255,
        0
    ],
    [
        0,
        255,
        51
    ],
    [
        0,
        255,
        102
    ],
    [
        0,
        255,
        153
    ],
    [
        0,
        255,
        204
    ],
    [
        0,
        255,
        255
    ],
    [
        51,
        0,
        0
    ],
    [
        51,
        0,
        51
    ],
    [
        51,
        0,
        102
    ],
    [
        51,
        0,
        153
    ],
    [
        51,
        0,
        204
    ],
    [
        51,
        0,
        255
    ],
    [
        51,
        51,
        0
    ],
    [
        51,
        51,
        51
    ],
    [
        51,
        51,
        102
    ],
    [
        51,
        51,
        153
    ],
    [
        51,
        51,
        204
    ],
    [
        51,
        51,
        255
    ],
    [
        51,
        102,
        0
    ],
    [
        51,
        102,
        51
    ],
    [
        51,
        102,
        102
    ],
    [
        51,
        102,
        153
    ],
    [
        51,
        102,
        204
    ],
    [
        51,
        102,
        255
    ],
    [
        51,
        153,
        0
    ],
    [
        51,
        153,
        51
    ],
    [
        51,
        153,
        102
    ],
    [
        51,
        153,
        153
    ],
    [
        51,
        153,
        204
    ],
    [
        51,
        153,
        255
    ],
    [
        51,
        204,
        0
    ],
    [
        51,
        204,
        51
    ],
    [
        51,
        204,
        102
    ],
    [
        51,
        204,
        153
    ],
    [
        51,
        204,
        204
    ],
    [
        51,
        204,
        255
    ],
    [
        51,
        255,
        0
    ],
    [
        51,
        255,
        51
    ],
    [
        51,
        255,
        102
    ],
    [
        51,
        255,
        153
    ],
    [
        51,
        255,
        204
    ],
    [
        51,
        255,
        255
    ],
    [
        102,
        0,
        0
    ],
    [
        102,
        0,
        51
    ],
    [
        102,
        0,
        102
    ],
    [
        102,
        0,
        153
    ],
    [
        102,
        0,
        204
    ],
    [
        102,
        0,
        255
    ],
    [
        102,
        51,
        0
    ],
    [
        102,
        51,
        51
    ],
    [
        102,
        51,
        102
    ],
    [
        102,
        51,
        153
    ],
    [
        102,
        51,
        204
    ],
    [
        102,
        51,
        255
    ],
    [
        102,
        102,
        0
    ],
    [
        102,
        102,
        51
    ],
    [
        102,
        102,
        102
    ],
    [
        102,
        102,
        153
    ],
    [
        102,
        102,
        204
    ],
    [
        102,
        102,
        255
    ],
    [
        102,
        153,
        0
    ],
    [
        102,
        153,
        51
    ],
    [
        102,
        153,
        102
    ],
    [
        102,
        153,
        153
    ],
    [
        102,
        153,
        204
    ],
    [
        102,
        153,
        255
    ],
    [
        102,
        204,
        0
    ],
    [
        102,
        204,
        51
    ],
    [
        102,
        204,
        102
    ],
    [
        102,
        204,
        153
    ],
    [
        102,
        204,
        204
    ],
    [
        102,
        204,
        255
    ],
    [
        102,
        255,
        0
    ],
    [
        102,
        255,
        51
    ],
    [
        102,
        255,
        102
    ],
    [
        102,
        255,
        153
    ],
    [
        102,
        255,
        204
    ],
    [
        102,
        255,
        255
    ],
    [
        153,
        0,
        0
    ],
    [
        153,
        0,
        51
    ],
    [
        153,
        0,
        102
    ],
    [
        153,
        0,
        153
    ],
    [
        153,
        0,
        204
    ],
    [
        153,
        0,
        255
    ],
    [
        153,
        51,
        0
    ],
    [
        153,
        51,
        51
    ],
    [
        153,
        51,
        102
    ],
    [
        153,
        51,
        153
    ],
    [
        153,
        51,
        204
    ],
    [
        153,
        51,
        255
    ],
    [
        153,
        102,
        0
    ],
    [
        153,
        102,
        51
    ],
    [
        153,
        102,
        102
    ],
    [
        153,
        102,
        153
    ],
    [
        153,
        102,
        204
    ],
    [
        153,
        102,
        255
    ],
    [
        153,
        153,
        0
    ],
    [
        153,
        153,
        51
    ],
    [
        153,
        153,
        102
    ],
    [
        153,
        153,
        153
    ],
    [
        153,
        153,
        204
    ],
    [
        153,
        153,
        255
    ],
    [
        153,
        204,
        0
    ],
    [
        153,
        204,
        51
    ],
    [
        153,
        204,
        102
    ],
    [
        153,
        204,
        153
    ],
    [
        153,
        204,
        204
    ],
    [
        153,
        204,
        255
    ],
    [
        153,
        255,
        0
    ],
    [
        153,
        255,
        51
    ],
    [
        153,
        255,
        102
    ],
    [
        153,
        255,
        153
    ],
    [
        153,
        255,
        204
    ],
    [
        153,
        255,
        255
    ],
    [
        204,
        0,
        0
    ],
    [
        204,
        0,
        51
    ],
    [
        204,
        0,
        102
    ],
    [
        204,
        0,
        153
    ],
    [
        204,
        0,
        204
    ],
    [
        204,
        0,
        255
    ],
    [
        204,
        51,
        0
    ],
    [
        204,
        51,
        51
    ],
    [
        204,
        51,
        102
    ],
    [
        204,
        51,
        153
    ],
    [
        204,
        51,
        204
    ],
    [
        204,
        51,
        255
    ],
    [
        204,
        102,
        0
    ],
    [
        204,
        102,
        51
    ],
    [
        204,
        102,
        102
    ],
    [
        204,
        102,
        153
    ],
    [
        204,
        102,
        204
    ],
    [
        204,
        102,
        255
    ],
    [
        204,
        153,
        0
    ],
    [
        204,
        153,
        51
    ],
    [
        204,
        153,
        102
    ],
    [
        204,
        153,
        153
    ],
    [
        204,
        153,
        204
    ],
    [
        204,
        153,
        255
    ],
    [
        204,
        204,
        0
    ],
    [
        204,
        204,
        51
    ],
    [
        204,
        204,
        102
    ],
    [
        204,
        204,
        153
    ],
    [
        204,
        204,
        204
    ],
    [
        204,
        204,
        255
    ],
    [
        204,
        255,
        0
    ],
    [
        204,
        255,
        51
    ],
    [
        204,
        255,
        102
    ],
    [
        204,
        255,
        153
    ],
    [
        204,
        255,
        204
    ],
    [
        204,
        255,
        255
    ],
    [
        255,
        0,
        0
    ],
    [
        255,
        0,
        51
    ],
    [
        255,
        0,
        102
    ],
    [
        255,
        0,
        153
    ],
    [
        255,
        0,
        204
    ],
    [
        255,
        0,
        255
    ],
    [
        255,
        51,
        0
    ],
    [
        255,
        51,
        51
    ],
    [
        255,
        51,
        102
    ],
    [
        255,
        51,
        153
    ],
    [
        255,
        51,
        204
    ],
    [
        255,
        51,
        255
    ],
    [
        255,
        102,
        0
    ],
    [
        255,
        102,
        51
    ],
    [
        255,
        102,
        102
    ],
    [
        255,
        102,
        153
    ],
    [
        255,
        102,
        204
    ],
    [
        255,
        102,
        255
    ],
    [
        255,
        153,
        0
    ],
    [
        255,
        153,
        51
    ],
    [
        255,
        153,
        102
    ],
    [
        255,
        153,
        153
    ],
    [
        255,
        153,
        204
    ],
    [
        255,
        153,
        255
    ],
    [
        255,
        204,
        0
    ],
    [
        255,
        204,
        51
    ],
    [
        255,
        204,
        102
    ],
    [
        255,
        204,
        153
    ],
    [
        255,
        204,
        204
    ],
    [
        255,
        204,
        255
    ],
    [
        255,
        255,
        0
    ],
    [
        255,
        255,
        51
    ],
    [
        255,
        255,
        102
    ],
    [
        255,
        255,
        153
    ],
    [
        255,
        255,
        204
    ],
    [
        255,
        255,
        255
    ],

	[
		234,234,234
	],
    [
        212,
        212,
        212
    ],
	[
		191,191,191
	],
    [
        170,
        170,
        170
    ],
	[
		149,149,149
	],
    [
        128,
        128,
        128
    ],
	[
		106,106,106
	],
    [
        85,
        85,
        85
    ],
	[
		64,64,64
	],
    [
        43,
        43,
        43
    ],
	[
		21,21,21
	],
];

var fileData = fs.readFileSync('output/nationalmuseum/20160222-NM.json');
var data = JSON.parse(fileData);

_.each(data.files, function(file) {
	var imageData = fs.readFileSync('output/nationalmuseum/images/png/'+file.obj_id+'.png');

	var image = new Canvas.Image;
	image.src = imageData;

	var canvas = new Canvas(image.width, image.height);
	var ctx = canvas.getContext('2d');
	ctx.drawImage(image, 0, 0, image.width, image.height);

	var imageColors3 = _.map(colorThief.createPalette(canvas, 3), function(color) {
			return colorObject(color);
	});
	var imageColors5 = _.map(colorThief.createPalette(canvas, 5), function(color) {
			return colorObject(color);
	});
	var imageColors10 = _.map(colorThief.createPalette(canvas, 10), function(color) {
			return colorObject(color);
	});
	var dominantColor = colorObject(colorThief.getDominantColor(canvas));

	file.colors = {
		three: imageColors3,
		five: imageColors5,
		five_mapped: _.map(imageColors5, function(color) {
			var mappedColor = mapColorToPalette(color.rgb);

			return colorObject(mappedColor);
		}),
		ten: imageColors10,
		ten_mapped: _.map(imageColors10, function(color) {
			var mappedColor = mapColorToPalette(color.rgb);

			return colorObject(mappedColor);
		})
	};

	file.dominantColor = dominantColor;
;
});

fs.writeFile('output/nationalmuseum/20160222-NM.json', JSON.stringify(data, null, '\t'));